<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>手語翻譯系統</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/pose/pose.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
    <style>
        body { padding: 20px; }
        #video { width: 100%; max-width: 640px; height: auto; }
        #result { margin-top: 20px; }
        .preview-frame { width: 100px; height: 100px; object-fit: cover; margin: 5px; }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="text-center">手語翻譯系統</h1>
        <div class="text-center">
            <video id="video" autoplay playsinline></video>
            <div class="mt-3">
                <button id="startBtn" class="btn btn-primary">開始捕捉</button>
                <button id="stopBtn" class="btn btn-danger" disabled>停止捕捉</button>
            </div>
            <div id="framePreview" class="d-flex flex-wrap"></div>
            <div id="result" class="alert alert-info" style="display: none;"></div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let stream, frames = [];
        const video = document.getElementById('video');
        const startBtn = document.getElementById('startBtn');
        const stopBtn = document.getElementById('stopBtn');
        const framePreview = document.getElementById('framePreview');
        const resultDiv = document.getElementById('result');

        const pose = new Pose({
            locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/pose/${file}`
        });
        pose.setOptions({
            modelComplexity: 1,
            smoothLandmarks: true,
            minDetectionConfidence: 0.5,
            minTrackingConfidence: 0.5
        });
        pose.onResults(onPoseResults);

        function onPoseResults(results) {
            if (results.poseLandmarks) {
                const keypoints = [];
                for (let i = 0; i < Math.min(74, results.poseLandmarks.length); i++) {
                    const landmark = results.poseLandmarks[i];
                    keypoints.push(landmark.x, landmark.y, landmark.z);
                }
                while (keypoints.length < 74 * 3) {
                    keypoints.push(0);
                }
                frames.push(keypoints.slice(0, 74 * 3));
                const img = document.createElement('img');
                img.src = '#';
                img.classList.add('preview-frame');
                framePreview.appendChild(img);
            }
        }

        async function startCamera() {
            try {
                stream = await navigator.mediaDevices.getUserMedia({ video: true });
                video.srcObject = stream;
                startBtn.disabled = true;
                stopBtn.disabled = false;
                const camera = new Camera(video, {
                    onFrame: async () => {
                        await pose.send({ image: video });
                    },
                    width: 640,
                    height: 480
                });
                camera.start();
            } catch (err) {
                resultDiv.style.display = 'block';
                resultDiv.textContent = '無法訪問攝影機: ' + err;
            }
        }

        function stopCamera() {
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
                video.srcObject = null;
                startBtn.disabled = false;
                stopBtn.disabled = true;
                sendFrames();
            }
        }

        function captureFrames() {
            if (frames.length >= 100) {
                stopCamera();
                return;
            }
            setTimeout(captureFrames, 100);
        }

        async function sendFrames() {
            try {
                const response = await fetch('/predict', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ frames })
                });
                const data = await response.json();
                if (data.error) {
                    resultDiv.style.display = 'block';
                    resultDiv.textContent = '錯誤: ' + data.error;
                } else {
                    resultDiv.style.display = 'block';
                    resultDiv.textContent = `手勢: ${data.gesture} (機率: ${data.probabilities.map(p => p.toFixed(4)).join(', ')})`;
                }
                frames = [];
                framePreview.innerHTML = '';
            } catch (err) {
                resultDiv.style.display = 'block';
                resultDiv.textContent = '發送幀失敗: ' + err;
            }
        }

        startBtn.addEventListener('click', startCamera);
        stopBtn.addEventListener('click', stopCamera);
    </script>
</body>
</html>